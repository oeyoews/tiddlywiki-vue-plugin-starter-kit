<html>

<body>
	<script>
		async function rss2json(input, isUrl = true) {
			try {
				const parser = new DOMParser();
				let xmlString = '';

				if (isUrl) {
					const res = await fetch(input);
					xmlString = await res.text();
				} else {
					xmlString = input;
				}

				const xmlDoc = parser.parseFromString(xmlString, 'text/xml');

				const getContent = (el, tag) => el?.getElementsByTagName(tag)[0]?.textContent || '';

				let channelNode = xmlDoc.querySelector('channel') || xmlDoc.documentElement;
				const channel = {
					title: getContent(channelNode, 'title'),
					link: getContent(channelNode, 'link'),
					description: getContent(channelNode, 'description'),
					update:
						getContent(channelNode, 'lastBuildDate') ||
						getContent(channelNode, 'pubDate') ||
						getContent(channelNode, 'updated'),
				};

				let items = xmlDoc.getElementsByTagName('item');
				if (!items.length) {
					items = xmlDoc.getElementsByTagName('entry');
				}

				const result = [];
				for (let i = 0; i < items.length; i++) {
					const item = items[i];
					let content = getContent(item, 'content') || getContent(item, 'content:encoded');
					const summary = getContent(item, 'description') + (content || '');

					result.push({
						title: getContent(item, 'title'),
						link: getContent(item, 'link'),
						update: getContent(item, 'pubDate') || getContent(item, 'updated'),
						summary,
						mp3: item?.getElementsByTagName('enclosure')[0]?.getAttribute('url') || '',
					});
				}

				return { channel, items: result };
			} catch (e) {
				console.error('rss2json error:', e);
				throw e;
			}
		}

		// 从 url 加载
		rss2json('https://talk.tiddlywiki.org/posts.rss').then(console.log);

		// 从 XML 字符串解析
		rss2json(xmlString, false).then(console.log);


	</script>
</body>

</html>