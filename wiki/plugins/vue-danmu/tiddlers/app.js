"use strict";const e=window.Vue,he="1.0.0",$=e.defineComponent({__name:"Danmaku",props:{danmus:{},channels:{default:0},autoplay:{type:Boolean,default:!0},loop:{type:Boolean,default:!1},useSlot:{type:Boolean,default:!1},useSuspendSlot:{type:Boolean,default:!1},debounce:{default:100},speeds:{default:100},randomChannel:{type:Boolean,default:!1},fontSize:{default:18},top:{default:10},right:{default:10},isSuspend:{type:Boolean,default:!1},extraStyle:{default:""}},emits:["list-end","play-end","dm-click","update:danmus"],setup(y,{expose:m,emit:p}){const W=y,_=e.useSlots(),{danmus:V,channels:N,autoplay:T,loop:d,useSlot:r,debounce:v,speeds:M,randomChannel:K,fontSize:R,top:z,right:Q,isSuspend:g,extraStyle:X,useSuspendSlot:Y}=e.toRefs(W),H=e.ref(),c=e.ref(),x=e.ref(0),A=e.ref(0);let B=null;const j=e.ref(0),E=e.ref(0),f=e.ref(0),L=e.ref(0),S=e.ref(!1),k=e.ref(!1),C=e.ref({}),h=e.ref([]),O=e.ref(10),i=e.computed({get:()=>V.value,set:a=>{p("update:danmus",a)}}),I=e.computed(()=>N.value||j.value);function q(){U(),g.value&&!r.value&&se(),T.value&&w()}function U(){x.value=H.value.offsetWidth,A.value=H.value.offsetHeight}function w(){k.value=!1,!B&&i.value.length&&(B=setInterval(()=>Z(),v.value))}function Z(){if(!k.value&&i.value.length)if(f.value>i.value.length-1+L.value){const a=c.value.children.length;d.value?(f.value>=i.value.length&&(p("list-end"),f.value=0),P()):a<f.value&&F()}else P()}const b=e.ref([]);function P(a){a&&b.value.push(a);const l=d.value?f.value%i.value.length:f.value-L.value;let n=a||i.value[l],s=!1;b.value.length>L.value&&(n=b.value[L.value],s=!0);let t=document.createElement("div"),u=document.createElement("div");r.value?t=ne(n,l):(t.innerHTML=n,t.setAttribute("style",X.value),t.style.fontSize=`${R.value}px`,t.style.lineHeight=`${R.value}px`),t.style.opacity="0",t.classList.add("dm"),g.value&&Y.value&&(u=ae(n,l).childNodes[1],u.classList.add("dm-suspend"),u.style.background="transparent",u.style.display="none",r.value?u&&t.childNodes[1]&&t.childNodes[1].appendChild(u):u&&t.appendChild(u)),c.value&&c.value.appendChild(t),e.nextTick(()=>{E.value||(E.value=t.offsetHeight),N.value||(j.value=Math.floor(A.value/(E.value+z.value))),O.value=u.offsetWidth+10+Q.value;let D=ee(t);if(D>=0){const J=t.offsetWidth,pe=E.value;t.classList.add("move"),t.dataset.index=`${l}`,t.style.top=D*(pe+z.value)+"px",t.style.width=J+"px",t.style.opacity="1",t.style.setProperty("--dm-scroll-width",`-${x.value+J*2}px`),t.style.left=`${x.value}px`,t.style.animationDuration=`${x.value/M.value}s`,t.addEventListener("animationend",()=>{Number(t.dataset.index)===i.value.length-1&&!d.value&&p("play-end",Number(t.dataset.index)),c.value&&c.value.removeChild(t)},{once:!0}),f.value++,(a||s)&&(k.value=!1,L.value++)}else c.value.removeChild(t)})}function ee(a){let l=[...Array(I.value).keys()];K.value&&(l=l.sort(()=>.5-Math.random()));for(const n of l){const s=C.value[n];if(s&&s.length)for(let t=0;t<s.length;t++){const u=te(s[t])-O.value;if(u<=(a.offsetWidth-s[t].offsetWidth)*.88||u<=0)break;if(t===s.length-1)return C.value[n].push(a),a.addEventListener("animationend",()=>C.value[n].splice(0,1),{once:!0}),n%I.value}else return C.value[n]=[a],a.addEventListener("animationend",()=>C.value[n].splice(0,1),{once:!0}),n%I.value}return-1}function te(a){const l=a.offsetWidth||parseInt(a.style.width),n=a.getBoundingClientRect().right||c.value.getBoundingClientRect().right+l;return c.value.getBoundingClientRect().right-n}function ne(a,l){const n=e.ref(document.createElement("div"));return e.render(e.h("div",{onClick:()=>{p("dm-click",a,l)},onmouseover:s=>{if(!g.value)return;const t=s.target.closest(".dm");if(!t)return;const u=t.getElementsByClassName("dm-suspend")[0];g.value&&u&&(u.style.display="flex"),t.classList.add("pause"),h.value.includes(t)||(h.value.push(t),le())},onmouseout:s=>{if(!g.value)return;const t=s.target.closest(".dm");if(!t)return;const u=t.getElementsByClassName("dm-suspend")[0];if(g.value&&u&&(u.style.display="none"),t.classList.remove("pause"),h.value.includes(t)){const D=h.value.indexOf(t);h.value.splice(D,1)}}},[_.dm&&_.dm({danmu:a,index:l})]),n.value),n.value.childNodes[0]}function ae(a,l){const n=e.ref(document.createElement("div"));return e.render(e.h("div",{},[_.suspend&&_.suspend({danmu:a,index:l})]),n.value),n.value.childNodes[0]}function le(){document.body.addEventListener("mouseout",a=>{a.stopImmediatePropagation(),h.value.length&&(h.value.map(l=>{l.classList.remove("pause")}),h.value=[])},{once:!0})}function se(){let a=[];c.value.addEventListener("mousemove",l=>{let n=l.target;if(n.className.includes("dm")||(n=n.closest(".dm")||n),!n.className.includes("dm"))return;const s=n.getElementsByClassName("dm-suspend")[0];g.value&&s&&(s.style.display="flex"),n.classList.add("pause"),a.push(n)}),c.value.addEventListener("mouseout",l=>{let n=l.target;if(n.className.includes("dm")||(n=n.closest(".dm")||n),!n.className.includes("dm"))return;const s=n.getElementsByClassName("dm-suspend")[0];g.value&&s&&(s.style.display="none"),n.classList.remove("pause"),a.forEach(t=>{t.classList.remove("pause")}),a=[]})}function F(){clearInterval(B),B=null}function ue(){E.value=0,q()}function G(){C.value={},c.value.innerHTML="",k.value=!0,S.value=!1,F(),f.value=0,h.value=[]}function oe(){k.value=!0}function ie(){S.value=!1}function de(){S.value=!0}function re(a){if(f.value>=i.value.length-1)return i.value.push(a),w(),i.value.length-1;{const l=f.value%i.value.length;return i.value.splice(l,0,a),w(),l-1}}function ce(a){return i.value.push(a),i.value.length-1}function ve(){U();const a=c.value.getElementsByClassName("dm");for(let l=0;l<a.length;l++){const n=a[l];n.style.setProperty("--dm-scroll-width",`-${x.value+n.offsetWidth*2}px`),n.style.left=`${x.value}px`,n.style.animationDuration=`${x.value/M.value}s`}}function fe(){return!k.value}function me(){return b.value}return e.onMounted(()=>{console.log(`%c danmaku-vue %c V${he} `,"padding: 2px 1px; border-radius: 3px 0 0 3px; color: #fff; background: #606060; font-weight: bold;","padding: 2px 1px; border-radius: 0 3px 3px 0; color: #fff; background: #42c02e; font-weight: bold;"),q()}),e.onBeforeUnmount(()=>{G()}),m({add:re,push:ce,insert:P,play:w,pause:oe,reset:ue,resize:ve,show:ie,hide:de,clear:G,getPlayState:fe,getInsertList:me}),(a,l)=>(e.openBlock(),e.createElementBlock("div",{ref_key:"container",ref:H,class:"danmaku-container"},[e.createElementVNode("div",{ref_key:"dmContainer",ref:c,class:e.normalizeClass(["danmus",{show:!S.value},{paused:k.value}])},[e.renderSlot(a.$slots,"default")],2)],512))}});$.install=y=>{y.component($.__name,$)};const ge={class:"danmaku-container"},ye=["src"],xe={class:"danmu-suspend"},ke=["onClick"],o="https://tiddlywiki.com/favicon.ico",_e=e.defineComponent({__name:"Danmaku",setup(y){const m=e.ref(),p=e.ref([{text:"TiddlyWiki 是一个非线性笔记本",avatar:o},{text:"支持 Vue 3 组件集成",avatar:o},{text:"可以创建自定义插件",avatar:o},{text:"Tiddlers 是 TiddlyWiki 的基本单元",avatar:o},{text:"使用 widget 可以扩展功能",avatar:o},{text:"支持 Markdown 和 WikiText 语法",avatar:o},{text:"可以导出为单个 HTML 文件",avatar:o},{text:"标签系统非常强大",avatar:o},{text:"可以使用筛选器查询数据",avatar:o},{text:"支持自定义主题和样式",avatar:o},{text:"可以创建宏简化操作",avatar:o},{text:"支持插件开发和分享",avatar:o},{text:"TiddlyWiki 社区非常活跃",avatar:o},{text:"可以使用 Node.js 作为服务器",avatar:o},{text:"支持多语言界面",avatar:o}]),W=e.reactive({useSlot:!0,useSuspendSlot:!0,isSuspend:!0,randomChannel:!0,loop:!0,right:20,channels:8,speeds:100,autoplay:!0,channelHeight:30});function _(d,r){console.log("当前点击的弹幕:>> ",r,d)}function V(d){console.log("播放结束",d)}function N(){console.log("循环播放一轮结束")}function T(d){var v;const r={...d,isMe:!0};(v=m.value)==null||v.insert(r)}return e.onMounted(()=>{setTimeout(()=>{var d,r;(d=m.value)==null||d.resize(),(r=m.value)==null||r.play()},500)}),(d,r)=>(e.openBlock(),e.createElementBlock("div",ge,[e.createVNode(e.unref($),e.mergeProps({ref_key:"danmaku",ref:m,danmus:p.value},W,{onDmClick:_,onPlayEnd:V,onListEnd:N}),{dm:e.withCtx(({danmu:v})=>[e.createElementVNode("div",{class:e.normalizeClass(["danmu-item",[v.isMe?"btn-item--me":""]])},[v.avatar?(e.openBlock(),e.createElementBlock("img",{key:0,class:"danmu-item--avatar",src:v.avatar,alt:""},null,8,ye)):e.createCommentVNode("",!0),e.createElementVNode("div",null,e.toDisplayString(v.text),1)],2)]),suspend:e.withCtx(({danmu:v})=>[e.createElementVNode("div",xe,[e.createElementVNode("div",{class:"item",onClick:M=>T(v)}," ➕ ",8,ke),r[0]||(r[0]=e.createElementVNode("div",{class:"item"},"👍",-1))])]),_:1},16,["danmus"])]))}}),Ce=e.defineComponent({__name:"App",props:{title:{},theme:{},showLogos:{type:Boolean}},setup(y){return(m,p)=>(e.openBlock(),e.createBlock(_e))}});function Ee(y={}){return function(m={}){const p={...y,...m};return{render(){return e.h(Ce,p)}}}}module.exports=Ee;
