"use strict";const e=window.Vue,pe="1.0.0",D=e.defineComponent({__name:"Danmaku",props:{danmus:{},channels:{default:0},autoplay:{type:Boolean,default:!0},loop:{type:Boolean,default:!1},useSlot:{type:Boolean,default:!1},useSuspendSlot:{type:Boolean,default:!1},debounce:{default:100},speeds:{default:100},randomChannel:{type:Boolean,default:!1},fontSize:{default:18},top:{default:10},right:{default:10},isSuspend:{type:Boolean,default:!1},extraStyle:{default:""}},emits:["list-end","play-end","dm-click","update:danmus"],setup(g,{expose:f,emit:c}){const $=g,C=e.useSlots(),{danmus:V,channels:N,autoplay:W,loop:i,useSlot:d,debounce:v,speeds:H,randomChannel:J,fontSize:R,top:z,right:K,isSuspend:h,extraStyle:Q,useSuspendSlot:X}=e.toRefs($),I=e.ref(),r=e.ref(),y=e.ref(0),T=e.ref(0);let S=null;const A=e.ref(0),k=e.ref(0),m=e.ref(0),E=e.ref(0),B=e.ref(!1),x=e.ref(!1),_=e.ref({}),p=e.ref([]),O=e.ref(10),o=e.computed({get:()=>V.value,set:a=>{c("update:danmus",a)}}),M=e.computed(()=>N.value||A.value);function j(){q(),h.value&&!d.value&&le(),W.value&&L()}function q(){y.value=I.value.offsetWidth,T.value=I.value.offsetHeight}function L(){x.value=!1,!S&&o.value.length&&(S=setInterval(()=>Y(),v.value))}function Y(){if(!x.value&&o.value.length)if(m.value>o.value.length-1+E.value){const a=r.value.children.length;i.value?(m.value>=o.value.length&&(c("list-end"),m.value=0),P()):a<m.value&&U()}else P()}const b=e.ref([]);function P(a){a&&b.value.push(a);const l=i.value?m.value%o.value.length:m.value-E.value;let n=a||o.value[l],s=!1;b.value.length>E.value&&(n=b.value[E.value],s=!0);let t=document.createElement("div"),u=document.createElement("div");d.value?t=te(n,l):(t.innerHTML=n,t.setAttribute("style",Q.value),t.style.fontSize=`${R.value}px`,t.style.lineHeight=`${R.value}px`),t.style.opacity="0",t.classList.add("dm"),h.value&&X.value&&(u=ne(n,l).childNodes[1],u.classList.add("dm-suspend"),u.style.background="transparent",u.style.display="none",d.value?u&&t.childNodes[1]&&t.childNodes[1].appendChild(u):u&&t.appendChild(u)),r.value&&r.value.appendChild(t),e.nextTick(()=>{k.value||(k.value=t.offsetHeight),N.value||(A.value=Math.floor(T.value/(k.value+z.value))),O.value=u.offsetWidth+10+K.value;let w=Z(t);if(w>=0){const G=t.offsetWidth,me=k.value;t.classList.add("move"),t.dataset.index=`${l}`,t.style.top=w*(me+z.value)+"px",t.style.width=G+"px",t.style.opacity="1",t.style.setProperty("--dm-scroll-width",`-${y.value+G*2}px`),t.style.left=`${y.value}px`,t.style.animationDuration=`${y.value/H.value}s`,t.addEventListener("animationend",()=>{Number(t.dataset.index)===o.value.length-1&&!i.value&&c("play-end",Number(t.dataset.index)),r.value&&r.value.removeChild(t)},{once:!0}),m.value++,(a||s)&&(x.value=!1,E.value++)}else r.value.removeChild(t)})}function Z(a){let l=[...Array(M.value).keys()];J.value&&(l=l.sort(()=>.5-Math.random()));for(const n of l){const s=_.value[n];if(s&&s.length)for(let t=0;t<s.length;t++){const u=ee(s[t])-O.value;if(u<=(a.offsetWidth-s[t].offsetWidth)*.88||u<=0)break;if(t===s.length-1)return _.value[n].push(a),a.addEventListener("animationend",()=>_.value[n].splice(0,1),{once:!0}),n%M.value}else return _.value[n]=[a],a.addEventListener("animationend",()=>_.value[n].splice(0,1),{once:!0}),n%M.value}return-1}function ee(a){const l=a.offsetWidth||parseInt(a.style.width),n=a.getBoundingClientRect().right||r.value.getBoundingClientRect().right+l;return r.value.getBoundingClientRect().right-n}function te(a,l){const n=e.ref(document.createElement("div"));return e.render(e.h("div",{onClick:()=>{c("dm-click",a,l)},onmouseover:s=>{if(!h.value)return;const t=s.target.closest(".dm");if(!t)return;const u=t.getElementsByClassName("dm-suspend")[0];h.value&&u&&(u.style.display="flex"),t.classList.add("pause"),p.value.includes(t)||(p.value.push(t),ae())},onmouseout:s=>{if(!h.value)return;const t=s.target.closest(".dm");if(!t)return;const u=t.getElementsByClassName("dm-suspend")[0];if(h.value&&u&&(u.style.display="none"),t.classList.remove("pause"),p.value.includes(t)){const w=p.value.indexOf(t);p.value.splice(w,1)}}},[C.dm&&C.dm({danmu:a,index:l})]),n.value),n.value.childNodes[0]}function ne(a,l){const n=e.ref(document.createElement("div"));return e.render(e.h("div",{},[C.suspend&&C.suspend({danmu:a,index:l})]),n.value),n.value.childNodes[0]}function ae(){document.body.addEventListener("mouseout",a=>{a.stopImmediatePropagation(),p.value.length&&(p.value.map(l=>{l.classList.remove("pause")}),p.value=[])},{once:!0})}function le(){let a=[];r.value.addEventListener("mousemove",l=>{let n=l.target;if(n.className.includes("dm")||(n=n.closest(".dm")||n),!n.className.includes("dm"))return;const s=n.getElementsByClassName("dm-suspend")[0];h.value&&s&&(s.style.display="flex"),n.classList.add("pause"),a.push(n)}),r.value.addEventListener("mouseout",l=>{let n=l.target;if(n.className.includes("dm")||(n=n.closest(".dm")||n),!n.className.includes("dm"))return;const s=n.getElementsByClassName("dm-suspend")[0];h.value&&s&&(s.style.display="none"),n.classList.remove("pause"),a.forEach(t=>{t.classList.remove("pause")}),a=[]})}function U(){clearInterval(S),S=null}function se(){k.value=0,j()}function F(){_.value={},r.value.innerHTML="",x.value=!0,B.value=!1,U(),m.value=0,p.value=[]}function ue(){x.value=!0}function oe(){B.value=!1}function ie(){B.value=!0}function de(a){if(m.value>=o.value.length-1)return o.value.push(a),L(),o.value.length-1;{const l=m.value%o.value.length;return o.value.splice(l,0,a),L(),l-1}}function re(a){return o.value.push(a),o.value.length-1}function ce(){q();const a=r.value.getElementsByClassName("dm");for(let l=0;l<a.length;l++){const n=a[l];n.style.setProperty("--dm-scroll-width",`-${y.value+n.offsetWidth*2}px`),n.style.left=`${y.value}px`,n.style.animationDuration=`${y.value/H.value}s`}}function ve(){return!x.value}function fe(){return b.value}return e.onMounted(()=>{console.log(`%c danmaku-vue %c V${pe} `,"padding: 2px 1px; border-radius: 3px 0 0 3px; color: #fff; background: #606060; font-weight: bold;","padding: 2px 1px; border-radius: 0 3px 3px 0; color: #fff; background: #42c02e; font-weight: bold;"),j()}),e.onBeforeUnmount(()=>{F()}),f({add:de,push:re,insert:P,play:L,pause:ue,reset:se,resize:ce,show:oe,hide:ie,clear:F,getPlayState:ve,getInsertList:fe}),(a,l)=>(e.openBlock(),e.createElementBlock("div",{ref_key:"container",ref:I,class:"danmaku-container"},[e.createElementVNode("div",{ref_key:"dmContainer",ref:r,class:e.normalizeClass(["danmus",{show:!B.value},{paused:x.value}])},[e.renderSlot(a.$slots,"default")],2)],512))}});D.install=g=>{g.component(D.__name,D)};const he={class:"danmaku-container"},ge=["src"],ye={class:"danmu-suspend"},xe=["onClick"],Ce="https://github.com/dshuais/danmaku-vue/blob/main/src/assets/img/default-avatar%20(1).png?raw=true",_e=e.defineComponent({__name:"Danmaku",setup(g){const f=e.ref(),c=e.ref([{text:"弹幕示例1",avatar:Ce}]),$=e.reactive({useSlot:!0,useSuspendSlot:!0,isSuspend:!0,randomChannel:!0,loop:!0,right:20,channels:6,speeds:100,autoplay:!0});function C(i,d){console.log("当前点击的弹幕:>> ",d,i)}function V(i){console.log("播放结束",i)}function N(){console.log("循环播放一轮结束")}function W(i){var v;const d={...i,isMe:!0};(v=f.value)==null||v.insert(d)}return e.onMounted(()=>{setTimeout(()=>{var i,d;(i=f.value)==null||i.resize(),(d=f.value)==null||d.play()},500)}),(i,d)=>(e.openBlock(),e.createElementBlock("div",he,[e.createVNode(e.unref(D),e.mergeProps({ref_key:"danmaku",ref:f,danmus:c.value},$,{onDmClick:C,onPlayEnd:V,onListEnd:N}),{dm:e.withCtx(({danmu:v})=>[e.createElementVNode("div",{class:e.normalizeClass(["danmu-item",[v.isMe?"btn-item--me":""]])},[v.avatar?(e.openBlock(),e.createElementBlock("img",{key:0,class:"danmu-item--avatar",src:v.avatar,alt:""},null,8,ge)):e.createCommentVNode("",!0),e.createElementVNode("div",null,e.toDisplayString(v.text),1)],2)]),suspend:e.withCtx(({danmu:v})=>[e.createElementVNode("div",ye,[e.createElementVNode("div",{class:"item",onClick:H=>W(v)}," ➕ ",8,xe),d[0]||(d[0]=e.createElementVNode("div",{class:"item"},"👍",-1))])]),_:1},16,["danmus"])]))}}),ke={class:"vue-danmu-plugin"},Ee=e.defineComponent({__name:"App",props:{title:{},theme:{},showLogos:{type:Boolean}},setup(g){return(f,c)=>(e.openBlock(),e.createElementBlock("div",ke,[e.createElementVNode("h2",null,e.toDisplayString(f.title||"vue-danmu"),1),c[0]||(c[0]=e.createTextVNode(" Hello ")),e.createVNode(_e)]))}});function Ne(g={}){return function(f={}){const c={...g,...f};return{render(){return e.h(Ee,c)}}}}module.exports=Ne;
